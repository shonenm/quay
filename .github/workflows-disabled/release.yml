# cargo-dist release workflow
# This file was auto-generated and may be regenerated by `cargo dist init`
# See: https://opensource.axo.dev/cargo-dist/

name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v[0-9]+.*'
  pull_request:
    paths:
      - '.github/workflows/release.yml'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Create the release and upload artifacts
  plan:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.plan.outputs.tag }}
      version: ${{ steps.plan.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install cargo-dist
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-dist
      - name: Run cargo dist plan
        id: plan
        run: |
          cargo dist plan --tag="${{ github.ref_name }}" --output-format=json > plan.json
          echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          echo "version=$(jq -r '.releases[0].app_version' plan.json)" >> "$GITHUB_OUTPUT"

  # Build for macOS (Intel)
  build-x86_64-apple-darwin:
    needs: plan
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: x86_64-apple-darwin
      - name: Build
        run: cargo build --release --target x86_64-apple-darwin
      - name: Package
        run: |
          mkdir -p dist
          cp target/x86_64-apple-darwin/release/quay dist/
          cd dist && tar -czvf quay-${{ needs.plan.outputs.version }}-x86_64-apple-darwin.tar.gz quay
      - uses: actions/upload-artifact@v4
        with:
          name: artifacts-x86_64-apple-darwin
          path: dist/*.tar.gz

  # Build for macOS (Apple Silicon)
  build-aarch64-apple-darwin:
    needs: plan
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: aarch64-apple-darwin
      - name: Build
        run: cargo build --release --target aarch64-apple-darwin
      - name: Package
        run: |
          mkdir -p dist
          cp target/aarch64-apple-darwin/release/quay dist/
          cd dist && tar -czvf quay-${{ needs.plan.outputs.version }}-aarch64-apple-darwin.tar.gz quay
      - uses: actions/upload-artifact@v4
        with:
          name: artifacts-aarch64-apple-darwin
          path: dist/*.tar.gz

  # Build for Linux (x86_64, musl)
  build-x86_64-unknown-linux-musl:
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: x86_64-unknown-linux-musl
      - name: Install musl-tools
        run: sudo apt-get install -y musl-tools
      - name: Build
        run: cargo build --release --target x86_64-unknown-linux-musl
      - name: Package
        run: |
          mkdir -p dist
          cp target/x86_64-unknown-linux-musl/release/quay dist/
          cd dist && tar -czvf quay-${{ needs.plan.outputs.version }}-x86_64-unknown-linux-musl.tar.gz quay
      - uses: actions/upload-artifact@v4
        with:
          name: artifacts-x86_64-unknown-linux-musl
          path: dist/*.tar.gz

  # Build for Linux (aarch64, musl)
  build-aarch64-unknown-linux-musl:
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: aarch64-unknown-linux-musl
      - name: Install cross-compilation tools
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu musl-tools
          mkdir -p .cargo
          echo '[target.aarch64-unknown-linux-musl]' >> .cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> .cargo/config.toml
      - name: Build
        run: cargo build --release --target aarch64-unknown-linux-musl
      - name: Package
        run: |
          mkdir -p dist
          cp target/aarch64-unknown-linux-musl/release/quay dist/
          cd dist && tar -czvf quay-${{ needs.plan.outputs.version }}-aarch64-unknown-linux-musl.tar.gz quay
      - uses: actions/upload-artifact@v4
        with:
          name: artifacts-aarch64-unknown-linux-musl
          path: dist/*.tar.gz

  # Create GitHub Release
  release:
    needs:
      - plan
      - build-x86_64-apple-darwin
      - build-aarch64-apple-darwin
      - build-x86_64-unknown-linux-musl
      - build-aarch64-unknown-linux-musl
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: artifacts-*
          path: dist
          merge-multiple: true
      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.tar.gz > checksums-sha256.txt
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
            dist/checksums-sha256.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Generate shell installer
  installer:
    needs:
      - plan
      - release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - name: Generate installer script
        run: |
          cat > quay-installer.sh << 'INSTALLER_EOF'
          #!/bin/sh
          set -eu

          REPO="shonenm/quay"
          BINARY_NAME="quay"

          # Detect OS and architecture
          detect_target() {
            OS=$(uname -s | tr '[:upper:]' '[:lower:]')
            ARCH=$(uname -m)

            case "$OS" in
              darwin)
                case "$ARCH" in
                  x86_64) echo "x86_64-apple-darwin" ;;
                  arm64|aarch64) echo "aarch64-apple-darwin" ;;
                  *) echo "Unsupported architecture: $ARCH" >&2; exit 1 ;;
                esac
                ;;
              linux)
                case "$ARCH" in
                  x86_64) echo "x86_64-unknown-linux-musl" ;;
                  aarch64|arm64) echo "aarch64-unknown-linux-musl" ;;
                  *) echo "Unsupported architecture: $ARCH" >&2; exit 1 ;;
                esac
                ;;
              *) echo "Unsupported OS: $OS" >&2; exit 1 ;;
            esac
          }

          # Get latest version
          VERSION="${QUAY_VERSION:-latest}"
          if [ "$VERSION" = "latest" ]; then
            VERSION=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          fi

          TARGET=$(detect_target)
          DOWNLOAD_URL="https://github.com/$REPO/releases/download/$VERSION/$BINARY_NAME-${VERSION#v}-$TARGET.tar.gz"

          echo "Downloading $BINARY_NAME $VERSION for $TARGET..."
          TMPDIR=$(mktemp -d)
          curl -sL "$DOWNLOAD_URL" | tar -xz -C "$TMPDIR"

          INSTALL_DIR="${QUAY_INSTALL_DIR:-$HOME/.local/bin}"
          mkdir -p "$INSTALL_DIR"
          mv "$TMPDIR/$BINARY_NAME" "$INSTALL_DIR/"
          chmod +x "$INSTALL_DIR/$BINARY_NAME"
          rm -rf "$TMPDIR"

          echo "Installed $BINARY_NAME to $INSTALL_DIR/$BINARY_NAME"
          echo ""
          echo "Make sure $INSTALL_DIR is in your PATH:"
          echo "  export PATH=\"\$PATH:$INSTALL_DIR\""
          INSTALLER_EOF
      - name: Upload installer to release
        uses: softprops/action-gh-release@v2
        with:
          files: quay-installer.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
